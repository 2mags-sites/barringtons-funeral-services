name: Deploy to Subdomain

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸš€ Checkout code
      uses: actions/checkout@v3

    - name: ðŸ“¤ Deploy to barr.2magpiesseo.co.uk
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.WHM_HOST }}
        username: ${{ secrets.WHM_USERNAME }}
        key: ${{ secrets.WHM_SSH_KEY }}
        source: "*"
        target: "/home/twomagseo/barr.2magpiesseo.co.uk"
        rm: false

    - name: ðŸ”’ Set correct permissions
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.WHM_HOST }}
        username: ${{ secrets.WHM_USERNAME }}
        key: ${{ secrets.WHM_SSH_KEY }}
        script: |
          # Set correct ownership
          chown -R twomagseo:twomagseo /home/twomagseo/barr.2magpiesseo.co.uk

          # Set directory permissions
          find /home/twomagseo/barr.2magpiesseo.co.uk -type d -exec chmod 755 {} \;

          # Set file permissions
          find /home/twomagseo/barr.2magpiesseo.co.uk -type f -exec chmod 644 {} \;

          # Make uploads directory writable
          if [ -d "/home/twomagseo/barr.2magpiesseo.co.uk/assets/images/uploads" ]; then
            chmod 777 /home/twomagseo/barr.2magpiesseo.co.uk/assets/images/uploads
          fi

          # Protect .env file
          if [ -f "/home/twomagseo/barr.2magpiesseo.co.uk/.env" ]; then
            chmod 600 /home/twomagseo/barr.2magpiesseo.co.uk/.env
          fi

          echo "âœ… Deployment complete!"