name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸš€ Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 2  # Need previous commit to detect changes

    - name: ðŸ” Check what changed
      id: changes
      run: |
        # Check if any content/*.json files were modified in this commit
        # Handle initial commit (no HEAD~1)
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          if git diff --name-only HEAD~1 HEAD | grep -q "^content/.*\.json$"; then
            echo "content_changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Content files were modified - will deploy everything"
          else
            echo "content_changed=false" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Only code changes - will preserve production content"
          fi

          # List changed files for transparency
          echo "Changed files in this commit:"
          git diff --name-only HEAD~1 HEAD
        else
          # Initial commit - deploy everything
          echo "content_changed=true" >> $GITHUB_OUTPUT
          echo "ðŸŽ‰ Initial commit - deploying all files"
        fi

    - name: ðŸ“¦ Prepare deployment
      run: |
        echo "Preparing files for deployment..."

        # Always exclude backup files from deployment
        rm -rf content/backups 2>/dev/null || true

        # List what will be deployed
        echo "Content files to deploy:"
        ls -la content/

    - name: ðŸ“¤ Deploy to www.barringtonsfunerals.co.uk
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.WHM_HOST }}
        username: ${{ secrets.WHM_USERNAME }}
        key: ${{ secrets.WHM_SSH_KEY }}
        source: "*.php,*.html,.htaccess,.github,assets,content,includes,blog"
        target: "/home/bfunerals/public_html"
        rm: false  # Never remove existing files

    - name: ðŸ”’ Set correct permissions
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.WHM_HOST }}
        username: ${{ secrets.WHM_USERNAME }}
        key: ${{ secrets.WHM_SSH_KEY }}
        script: |
          # Set correct ownership
          chown -R bfunerals:bfunerals /home/bfunerals/public_html

          # Set directory permissions
          find /home/bfunerals/public_html -type d -exec chmod 755 {} \;

          # Set file permissions
          find /home/bfunerals/public_html -type f -exec chmod 644 {} \;

          # Make uploads directory writable
          if [ -d "/home/bfunerals/public_html/assets/images/uploads" ]; then
            chmod 777 /home/bfunerals/public_html/assets/images/uploads
          fi

          # Make content/backups directory writable for saving backups
          if [ -d "/home/bfunerals/public_html/content/backups" ]; then
            chmod 777 /home/bfunerals/public_html/content/backups
          else
            mkdir -p /home/bfunerals/public_html/content/backups
            chmod 777 /home/bfunerals/public_html/content/backups
          fi

          # Protect .env file
          if [ -f "/home/bfunerals/public_html/.env" ]; then
            chmod 600 /home/bfunerals/public_html/.env
          fi

          # Report what was deployed
          if [ "${{ steps.changes.outputs.content_changed }}" == "true" ]; then
            echo "âœ… Deployed: Code + Content files"
          else
            echo "âœ… Deployed: Code only (production content preserved)"
          fi